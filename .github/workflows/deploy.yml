# ================================================
# CI/CD - GitHub Actions
# Workflow d'intÃ©gration et dÃ©ploiement continu
# ================================================

name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '18'

jobs:
  # ================================================
  # JOB 1 : TESTS ET VALIDATION
  # ================================================
  test:
    name: Tests et Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Lint code
        run: npm run lint --if-present
        continue-on-error: true

      - name: ğŸ—ï¸ Build frontend
        run: npm run build

      - name: ğŸ“Š Check build size
        run: |
          echo "Build size:"
          du -sh dist/
          
      - name: âœ… Tests passed
        run: echo "All tests passed successfully!"

  # ================================================
  # JOB 2 : DÃ‰PLOIEMENT FRONTEND (Vercel)
  # ================================================
  deploy-frontend:
    name: Deploy Frontend
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'

  # ================================================
  # JOB 3 : NOTIFICATION
  # ================================================
  notify:
    name: Notification
    needs: [test, deploy-frontend]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: âœ… Success notification
        if: ${{ needs.test.result == 'success' && needs.deploy-frontend.result == 'success' }}
        run: |
          echo "âœ… DÃ©ploiement rÃ©ussi !"
          echo "ğŸš€ Application dÃ©ployÃ©e sur Vercel"
          
      - name: âŒ Failure notification
        if: ${{ needs.test.result == 'failure' || needs.deploy-frontend.result == 'failure' }}
        run: |
          echo "âŒ DÃ©ploiement Ã©chouÃ©"
          echo "VÃ©rifiez les logs ci-dessus"
